name: Disk Space Alert

on:
  workflow_dispatch:
  schedule:
    - cron: "* * * * */7"
  workflow_run:
    workflows:
      - Build Hugo site and upload to release
    types:
      - completed

jobs:
  check-disk:
    runs-on: self-hosted
    steps:
      - name: Check Disk Usage
        id: check_disk
        run: |
          DISK_USAGE=$(du -sm ~ | awk '{printf "%.1f", $1 / 1024}')
          TOTAL_DISK=4

          echo "DISK_USAGE=${DISK_USAGE}" >> $GITHUB_OUTPUT
          echo "TOTAL_DISK=${TOTAL_DISK}" >> $GITHUB_OUTPUT

          echo "## ðŸ“ ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨çŠ¶æ³ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "ç¾åœ¨ã®ãƒ‡ã‚£ã‚¹ã‚¯ã®ä½¿ç”¨é‡ã¯ ${DISK_USAGE} GB / ${TOTAL_DISK} GB ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY

      - name: Check Threshold
        run: |
          THRESHOLD=3
          DISK_USAGE=${{ steps.check_disk.outputs.DISK_USAGE }}
          TOTAL_DISK=${{ steps.check_disk.outputs.TOTAL_DISK }}

          if (( $(echo "$DISK_USAGE > $THRESHOLD" | bc -l) )); then
            echo "## âš ï¸ è­¦å‘Š: å¯¾å¿œãŒå¿…è¦" >> $GITHUB_STEP_SUMMARY
            echo "ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ãŒä¸Šé™ã«è¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "å¿…è¦ãªå ´åˆã«ã¯ã€æƒ…å ±åŸºç›¤ã‚»ãƒ³ã‚¿ãƒ¼ã«ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã®å¢—é‡ã‚’ä¾é ¼ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "## âœ… æ­£å¸¸: å¯¾å¿œã¯ä¸è¦" >> $GITHUB_STEP_SUMMARY
            echo "ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡ã¯æ­£å¸¸ã§ã™ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
